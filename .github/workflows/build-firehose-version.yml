# This workflow is not on master branch, so we have to run this using github CLI
# Run: echo '{"tag": "v0.34.22", "fh-tag": "v0.34.21-fh.2"}' | gh workflow run build-firehose-version.yml --ref=ajeet/fh-workflow --json

name: Build firehose version
run-name: ${{ inputs.dryrun && '[dryrun] ' || ''}}Creating p-${{ inputs.tag }}-fh <> tendermint/${{ inputs.tag }}..graphprotocol/${{inputs.fh-tag}}

on:
  workflow_dispatch:
    inputs:
      tag:
        type: string
        required: true
        description: 'tendermint/tendermint tag name'
      fh-tag:
        type: string
        required: true
        description: 'graphprotocol/tendermint firehose tag name'
      dryrun:
        type: boolean
        required: false
        default: false
    # This workflow was first run using push event
    # To make it available in the github workflow list
    # https://stackoverflow.com/questions/63362126/github-actions-how-to-run-a-workflow-created-on-a-non-master-branch-from-the-wo#:~:text=Specifically%20for%20workflow_dispatch,at%2016%3A32
    push:
      branches:
        - ajeet/fh-workflow

env:
  P_TAG: p-${{ inputs.tag }}-fh

jobs:
  tendermint-sdk-fh:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}

      - name: add remotes
        run: |
          git remote add tendermint https://github.com/tendermint/tendermint.git
          git remote add gp https://github.com/graphprotocol/tendermint.git

      - name: fetch tags
        run: |
          git fetch tendermint refs/tags/${{ inputs.tag }}:refs/tags/tendermint_${{ inputs.tag }} --no-tags
          git fetch gp refs/tags/${{ inputs.fh-tag }}:refs/tags/gp_${{ inputs.fh-tag }} --no-tags
          git fetch origin 'refs/tags/${{ env.P_TAG }}:refs/tags/${{ env.P_TAG }}' || echo ""

          echo "tags=$(git tag -l | tr '\n' ' ')" >> $GITHUB_ENV

      - if: contains(env.tags, env.P_TAG)
        name: exit if tag already exists
        run: |
          echo "::error::Tag: $P_TAG already exists"
          exit 1

      - name: print commit diff
        run: echo "::notice title=Commit diff::$(git log tendermint_${{ inputs.tag }}..gp_${{ inputs.fh-tag }} --pretty='%h | %s [%an]')"

      - if: '!inputs.dryrun'
        name: set git config
        run: git config user.name "${{ github.actor }}"

      - if: '!inputs.dryrun'
        id: fetch_commits
        name: 'fetch commits'
        run: echo "commits=$(git log tendermint_${{ inputs.tag }}..gp_${{ inputs.fh-tag }} --pretty="%H" --reverse | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - if: '!inputs.dryrun'
        name: 'apply commits and create new tag'
        run: |
          git checkout tendermint_${{ inputs.tag }}
          if [[ '${{ steps.fetch_commits.outputs.commits }}' != '' ]]; then
            git cherry-pick ${{ steps.fetch_commits.outputs.commits }}
          else
            echo "::warning title=No commit diff::No commit difference b/w tags; pushing tag ${{ env.P_TAG }} which is identical to tendermint/${{ inputs.tag }}"
          fi
          git tag ${{ env.P_TAG }}
          git push origin refs/tags/${{ env.P_TAG }}

      - if: failure() && !inputs.dryrun && !contains(env.tags, env.P_TAG)
        name: 'print manual steps'
        run: |
          STEPS=$(cat << EOF
          => Add remotes
          > git remote add tendermint https://github.com/tendermint/tendermint.git
          > git remote add gp https://github.com/graphprotocol/tendermint.git
          
          => Fetch tags
          > git fetch tendermint refs/tags/${{ inputs.tag }}:refs/tags/tendermint_${{ inputs.tag }} --no-tags
          > git fetch gp refs/tags/${{ inputs.fh-tag }}:refs/tags/gp_${{ inputs.fh-tag }} --no-tags
          
          => Check commit diff
          > git log tendermint_${{ inputs.tag }}..gp_${{ inputs.fh-tag }} --pretty='%h | %s [%an]'
          
          => Apply commits and create new tag
          > git checkout tendermint_${{ inputs.tag }}
          > git cherry-pick $(git log tendermint_${{ inputs.tag }}..gp_${{ inputs.fh-tag }} --pretty="%H" --reverse | tr '\n' ' ')
          > git tag ${{ env.P_TAG }}
          > git push origin refs/tags/${{ env.P_TAG }}
          EOF
          )
          STEPS="${STEPS//'%'/'%25'}"
          STEPS="${STEPS//$'\n'/'%0A'}"
          STEPS="${STEPS//$'\r'/'%0D'}"
          echo "::notice title=Manually do it?::$STEPS"
          